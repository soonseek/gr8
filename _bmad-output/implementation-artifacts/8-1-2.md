# Story 8-1-2: 첫 번째 운영자 프로비저닝 (First Admin Provisioning)

Status: done
Priority: HIGH (admin dashboard 접근 필수)

## Story

**As a** 시스템 관리자,
**I want** 첫 번째 운영자 계정을 쉽게 생성하고 싶다,
**So that** Admin Dashboard에 접근하여 플랫폼을 관리할 수 있다.

## 배경 (Context)

**문제:**
- Story 8-1-web3-auth-1에서 모든 사용자는 role="user"로 생성됨
- 첫 번째 운영자(role="admin")를 만들 방법이 없음
- SQL로 직접 INSERT하는 것은 사용자 친화적이지 않음

**해결:**
첫 번째 운영자 생성 전용 프로비저닝 프로세스 구현

## 수용 기준 (Acceptance Criteria)

### AC 1: 첫 번째 사용자 자동 운영자

**Given** users 테이블이 비어있을 때
**When** 첫 번째 사용자가 지갑을 연결하면
**Then** 자동으로 role="admin"으로 생성된다
**And** "첫 번째 사용자이므로 운영자로 지정되었습니다" 메시지가 표시된다

### AC 2: 이후 사용자는 일반 사용자

**Given** 이미 1명 이상의 사용자가 있을 때
**When** 새로운 사용자가 지갑을 연결하면
**Then** role="user"로 생성된다

### AC 3: 수동 운영자 생성 (관리자 도구)

**Given** 운영자가 Admin Dashboard에 접근했을 때
**When** "사용자 역할 변경" 기능을 사용하면
**Then** 일반 사용자의 역할을 admin으로 변경할 수 있다

## 기술 구현 (Technical Implementation)

### 백엔드: 첫 번째 사용자 자동 운영자

**파일:** `gr8-backend/app/api/routers/auth.py` (수정)

```python
@router.post("/api/auth/login")
async def login(
    wallet_address: str,
    message: str,
    signature: str,
    db: AsyncSession = Depends(get_db)
):
    # 서명 검증
    if not verify_web3_signature(message, signature, wallet_address):
        raise HTTPException(status_code=401, detail="Invalid signature")

    # 사용자 조회 또는 생성
    result = await db.execute(
        select(User).where(User.wallet_address == wallet_address.lower())
    )
    user = result.scalar_one_or_none()

    is_first_user = False

    if not user:
        # 첫 번째 사용자인지 확인
        count_result = await db.execute(select(func.count(User.id)))
        user_count = count_result.scalar() or 0

        # 첫 번째 사용자면 자동으로 admin
        role = "admin" if user_count == 0 else "user"
        is_first_user = (role == "admin")

        user = User(
            wallet_address=wallet_address.lower(),
            role=role
        )
        db.add(user)
        await db.commit()
        await db.refresh(user)

    # JWT 토큰 생성
    token = create_access_token(wallet_address)

    return {
        "access_token": token,
        "token_type": "bearer",
        "wallet_address": user.wallet_address,
        "role": user.role,
        "is_first_user": is_first_user  # 프론트엔드에서 메시지 표시용
    }
```

### 관리자 도구: 사용자 역할 변경

**파일:** `gr8-backend/app/api/admin.py` (추가)

```python
@router.post("/users/{wallet_address}/role")
async def update_user_role(
    wallet_address: str,
    new_role: str,
    current_admin = Depends(verify_admin_token),
    db: AsyncSession = Depends(get_db)
):
    """사용자 역할 변경 (운영자 전용)"""

    if new_role not in ['user', 'admin']:
        raise HTTPException(status_code=400, detail="Invalid role")

    result = await db.execute(
        select(User).where(User.wallet_address == wallet_address.lower())
    )
    user = result.scalar_one_or_none()

    if not user:
        raise HTTPException(status_code=404, detail="User not found")

    user.role = new_role
    await db.commit()

    return {
        "message": f"User {wallet_address} role updated to {new_role}"
    }
```

### 프론트엔트: 첫 운영자 알림

**파일:** `gr8-frontend/src/hooks/useAuth.ts` (수정)

```typescript
const handleAutoLogin = async () => {
  try {
    const signature = await signMessageAsync({ message: AUTH_MESSAGE })

    const response = await fetch('http://localhost:8000/api/auth/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        wallet_address: address,
        message: AUTH_MESSAGE,
        signature: signature
      })
    })

    const data = await response.json()

    localStorage.setItem('access_token', data.access_token)

    // 첫 번째 사용자 알림
    if (data.is_first_user) {
      alert("축하합니다! 첫 번째 사용자이므로 운영자로 지정되었습니다.")
    }

    setAuthState({
      isAuthenticated: true,
      token: data.access_token,
      user: {
        walletAddress: data.wallet_address,
        role: data.role
      }
    })

  } catch (error) {
    console.error('Auto login failed:', error)
  }
}
```

## Tasks / Subtasks

- [x] **Task 1: 백엔드 로그인 API 수정** (AC: #1, #2)
  - [x] Subtask 1.1: 첫 번째 사용자 확인 로직 추가
  - [x] Subtask 1.2: 자동 admin 할당 로직 추가
  - [x] Subtask 1.3: is_first_user 플래그 반환
  - [x] Subtask 1.4: 단위 테스트 작성

- [x] **Task 2: 사용자 역할 변경 API** (AC: #3)
  - [x] Subtask 2.1: POST /api/admin/users/{wallet_address}/role 엔드포인트
  - [x] Subtask 2.2: admin 권한 확인 미들웨어 적용
  - [x] Subtask 2.3: role 유효성 검증
  - [x] Subtask 2.4: 단위 테스트 작성

- [x] **Task 3: 프론트엔드 알림 구현**
  - [x] Subtask 3.1: is_first_user 확인
  - [x] Subtask 3.2: 알림 메시지 표시
  - [x] Subtask 3.3: Admin 전용 UI 노출

- [x] **Task 4: 테스트**
  - [x] Subtask 4.1: 첫 번째 사용자 admin 할당 테스트
  - [x] Subtask 4.2: 두 번째 사용자 user 할당 테스트
  - [x] Subtask 4.3: 역할 변경 API 테스트

- [x] **Task 5: 코드 리뷰 후속 조치 (AI Review)**
  - [x] Subtask 5.1: [HIGH] 첫 번째 사용자 확인 로직 Race Condition 수정 (`gr8-backend/app/api/routers/auth.py:90-91`)
    - 현재: `select(func.count(User.id))`와 사용자 생성 사이에 race condition 가능성
    - 개선안: 데이터베이스 레벨의 atomic lock 또는 UNIQUE constraint 활용, PostgreSQL의 SELECT ... FOR UPDATE 사용
    - **구현 완료**: nested transaction 사용하여 atomic하게 처리
  - [x] Subtask 5.2: [HIGH] Admin 자신의 역할 downgrade 방지 (`gr8-backend/app/api/admin.py:153-209`)
    - 현재: admin이 다른 admin의 역할을 변경 가능함
    - 개선안: 최소 1명의 admin 유지 logic 추가, "마지막 admin은 downgrade 불가" 에러 메시지 추가
    - **구현 완료**: admin 수 확인 후 마지막 admin downgrade 방지
  - [x] Subtask 5.3: [MEDIUM] alert()를 Toast notification으로 변경 (`gr8-frontend/src/hooks/useAuth.ts:102`)
    - 현재: `alert('축하합니다! 첫 번째 사용자이므로 운영자로 지정되었습니다.')`
    - 개선안: react-hot-toast 또는 sweetalert2 라이브러리 사용
    - **구현 완료**: react-hot-toast 설치 및 적용
  - [x] Subtask 5.4: [MEDIUM] 에러 메시지 한국어/영어 혼용 해결 (`gr8-frontend/src/hooks/useAuth.ts:117`)
    - 현재: "로그인에 실패했습니다" (한국어) + 백엔드 에러 (영어)
    - 개선안: 백엔드 i18n 지원 또는 에러 코드 기반 메시지 변환
    - **구현 완료**: getErrorMessage() 함수로 에러 메시지 한국어 변환
  - [x] Subtask 5.5: [LOW] TypeScript interface 명명 camelCase로 변경 (`gr8-frontend/src/hooks/useAuth.ts:4-7`)
    - 현재: `wallet_address: string` (snake_case)
    - 개선안: `walletAddress: string` (camelCase)
    - **구현 완료**: interface camelCase로 변경 및 호환성 유지
  - [x] Subtask 5.6: [CRITICAL] Web3 체인 전환 에러 수정 (`gr8-frontend/src/config/wagmi.ts:89-91`)
    - 현재: `transports: { [monadTestnet.id]: http() }` - RPC URL 미지정으로 체인 전환 실패
    - 에러: "An error occurred when attempting to switch chain. Details: Chain not configured."
    - 개선안: `transports: { [monadTestnet.id]: http('https://testnet-rpc.monad.xyz') }`
    - 영향: 사용자가 지갑 연결 후 체인 전환 불가하여 로그인 실패
    - **구현 완료**: RPC URL 추가

- [x] **Task 6: 수동 테스트 발견사항 수정 (CRITICAL)**
  - [x] Subtask 6.1: [CRITICAL] API URL 포트 번호 수정
    - 문제: 기본값이 `localhost:3001`인데 백엔드는 `localhost:8000`에서 실행
    - 수정: `API_URL` 기본값을 `http://localhost:8000/api`로 변경
    - 영향: 로그인 연결 실패 문제 해결
  - [x] Subtask 6.2: [HIGH] Toast 메시지 무한 반복 수정
    - 문제: useEffect 의존성 배열에 `authState.isAuthenticated` 포함으로 인한 무한 루프
    - 수정:
      1. `authState.isAuthenticated` 제거하고 `localStorage.getItem('access_token')`로 판단
      2. `loginInProgressRef` 추가하여 중복 실행 방지
      3. toast.error에 id 추가하여 중복 방지
    - 영향: 에러 발생 시 토스트 무한 반복 문제 해결
  - [x] Subtask 6.3: [HIGH] 로그아웃 후 UI 즉시 업데이트 수정
    - 문제: 로그아웃 후 "지갑 연결하기" 버튼이 나타나지 않고 새로고침해야 나옴
    - 원인: 각 컴포넌트에서 독립적으로 `useAuth()`를 호출하여 상태가 공유되지 않음
    - 수정:
      1. `AuthContext` 생성으로 전역 인증 상태 관리
      2. `AuthProvider`로 App 감싸서 모든 컴포넌트에 상태 공유
      3. `WalletInfo`, `WalletConnectionButton`, `AdminDashboard`에서 `useAuthContext()` 사용
      4. `WalletConnectionButton`가 `isConnected` 대신 `isAuthenticated` 확인하도록 변경
    - 영향: 로그아웃 후 즉시 "지갑 연결하기" 버튼 표시됨
  - [x] Subtask 6.4: [HIGH] 로그아웃 후 불필요한 로그인 에러 메시지 제거
    - 문제: 로그아웃 후 "로그인에 실패했습니다. 다시 시도해주세요." 메시지가 나타남
    - 원인: 로그아웃 후에도 지갑이 연결된 상태(`isConnected === true`)로 유지되어 자동 로그인 시도
    - 수정:
      1. `isLoggingOutRef` 플래그 추가하여 로그아웃 중인지 확인
      2. 로그아웃 시 `isLoggingOutRef.current = true`로 설정하여 자동 로그인 방지
      3. `handleAutoLogin` 시작 부분에서 `isLoggingOutRef` 확인 후 로그인 시도 중단
      4. 지갑 연결 해제(`!isConnected`) 시 `isLoggingOutRef` 초기화
    - 영향: 로그아웃 후 불필요한 로그인 시도 및 에러 메시지 제거됨

## 의존성 (Dependencies)

### 선행 Stories
- ✅ Story 8-1-web3-auth-1: /api/auth/login API
- ✅ Story 8-1-db-1: users 테이블 (role 컬럼)
- ✅ Story 8-1-web3-auth-2: verify_admin_token 미들웨어

### 관련 Stories
- Story 8-1-1: 프론트엔드 인증 통합 (선행)
- Story 8-1: Admin Dashboard

## 완료 조건 (Definition of Done)

- [x] 첫 번째 사용자 자동 admin 할당
- [x] 두 번째 사용자부터 자동 user 할당
- [x] 프론트엔드에서 "첫 운영자 지정" 메시지 표시
- [x] Admin Dashboard에서 사용자 역할 변경 가능
- [x] 단위 테스트 작성 및 통과 (109/109 테스트 통과, 81.38% 커버리지)
- [x] 통합 테스트 작성 및 통과

## Dev Agent Record

### Implementation Plan
1. **백엔드 로그인 API 수정** (`gr8-backend/app/api/routers/auth.py`)
   - 첫 번째 사용자 확인 로직 추가 (user_count == 0)
   - 자동 admin 할당 (role = "admin" if user_count == 0 else "user")
   - is_first_user 플래그 반환

2. **사용자 역할 변경 API** (`gr8-backend/app/api/admin.py`)
   - POST /api/admin/users/{wallet_address}/role 엔드포인트
   - verify_admin_token 미들웨어로 권한 확인
   - role 유효성 검증 (user/admin만 허용)

3. **프론트엔드 알림 구현** (`gr8-frontend/src/hooks/useAuth.ts`)
   - is_first_user 확인 후 알림 메시지 표시
   - AdminDashboard는 이미 role 확인 로직이 있음

### Completion Notes
✅ **Story 8-1-2 구현 완료 (코드 리뷰 후속 조치 포함)**

**초기 구현된 기능:**
1. 첫 번째 사용자 자동 admin 할당 기능
2. 두 번째 사용자부터 자동 user 할당
3. 사용자 역할 변경 API (admin 전용)
4. 프론트엔드 첫 운영자 지정 알림

**코드 리뷰 후속 조치 완료 (6개 항목):**
1. ✅ [CRITICAL] Web3 체인 전환 에러 수정 - RPC URL 추가
2. ✅ [HIGH] Race Condition 수정 - nested transaction으로 atomic 처리
3. ✅ [HIGH] Admin downgrade 방지 - 최소 1명 admin 유지 로직
4. ✅ [MEDIUM] Toast notification 적용 - react-hot-toast 설치 및 적용
5. ✅ [MEDIUM] 에러 메시지 i18n - getErrorMessage() 함수로 한국어 변환
6. ✅ [LOW] TypeScript interface camelCase 변경 - walletAddress로 변경

**수동 테스트 버그 수정 완료 (4개 항목):**
1. ✅ [CRITICAL] API URL 포트 번호 수정 - 3001 → 8000
2. ✅ [HIGH] Toast 무한 반복 수정 - useEffect 의존성 및 ref 추가
3. ✅ [HIGH] 로그아웃 후 UI 즉시 업데이트 - AuthContext 도입
4. ✅ [HIGH] 로그아웃 후 불필요한 로그인 에러 메시지 제거 - isLoggingOutRef 플래그 추가

**최종 테스트 결과:**
- ✅ 111/111 테스트 통과 (+2개 테스트 추가: 마지막 admin downgrade 방지)
- ✅ 커버리지 78.67% (새로운 admin 보호 로직으로 인한 감소)

**수정된 파일:**
**백엔드:**
- `gr8-backend/app/api/routers/auth.py` - Race Condition 수정 (nested transaction)
- `gr8-backend/app/api/admin.py` - 최소 admin 유지 로직

**프론트엔드 (코드 리뷰 후속 조치):**
- `gr8-frontend/src/config/wagmi.ts` - Web3 RPC URL 추가 (CRITICAL)
- `gr8-frontend/src/hooks/useAuth.ts` - Toast, i18n, camelCase 변경
- `gr8-frontend/src/App.tsx` - Toaster 컴포넌트 추가
- `gr8-frontend/package.json` - react-hot-toast 의존성 추가

**프론트엔드 (수동 테스트 버그 수정):**
- `gr8-frontend/src/contexts/AuthContext.tsx` - AuthContext 생성 (전역 상태 관리)
- `gr8-frontend/src/App.tsx` - AuthProvider 추가
- `gr8-frontend/src/components/WalletInfo.tsx` - useAuthContext 사용
- `gr8-frontend/src/components/WalletConnectionButton.tsx` - useAuthContext 사용, isAuthenticated 확인
- `gr8-frontend/src/pages/AdminDashboard.tsx` - useAuthContext 사용

**테스트:**
- `gr8-backend/tests/test_admin_dashboard.py` - 2개 테스트 추가 (마지막 admin 보호)

**기술적 결정:**
1. Race Condition 방지를 위해 SQLAlchemy의 nested transaction 사용
2. 최소 1명 admin 유지를 위해 admin 수 확인 후 downgrade 방지
3. react-hot-toast로 더 나은 UX 제공
4. 에러 메시지 한국어 변환으로 사용자 경험 개선
5. TypeScript interface camelCase로 변경하여 JavaScript 관례 따름
6. React Context 도입으로 전역 인증 상태 관리 및 로그아웃 후 즉시 UI 업데이트

### File List
**Initial Implementation:**
- `gr8-backend/app/api/routers/auth.py`
- `gr8-backend/app/api/admin.py`
- `gr8-backend/tests/test_auth_api.py`
- `gr8-backend/tests/test_admin_dashboard.py`
- `gr8-frontend/src/hooks/useAuth.ts`

**Code Review Follow-ups:**
- `gr8-backend/app/api/routers/auth.py` (Race Condition fix)
- `gr8-backend/app/api/admin.py` (Last admin protection)
- `gr8-backend/tests/test_admin_dashboard.py` (2 new tests)
- `gr8-frontend/src/config/wagmi.ts` (RPC URL fix)
- `gr8-frontend/src/hooks/useAuth.ts` (Toast, i18n, camelCase)
- `gr8-frontend/src/App.tsx` (Toaster component)
- `gr8-frontend/package.json` (react-hot-toast dependency)

**Manual Testing Bug Fixes:**
- `gr8-frontend/src/contexts/AuthContext.tsx` (NEW - AuthContext for global state)
- `gr8-frontend/src/App.tsx` (AuthProvider wrapper)
- `gr8-frontend/src/components/WalletInfo.tsx` (useAuthContext)
- `gr8-frontend/src/components/WalletConnectionButton.tsx` (useAuthContext, isAuthenticated check)
- `gr8-frontend/src/pages/AdminDashboard.tsx` (useAuthContext)
- `gr8-frontend/src/hooks/useAuth.ts` (API URL port fix: 3001 → 8000)

### Change Log
- 2026-01-16: 첫 번째 운영자 프로비저닝 기능 구현 완료
- 2026-01-16: AI 코드 리뷰 수행 - 6개 action item 생성 (HIGH: 2, MEDIUM: 2, LOW: 1, CRITICAL: 1)
- 2026-01-16: 코드 리뷰 후속 조치 완료 - 모든 6개 action item 해결
- 2026-01-16: 수동 테스트 버그 수정 완료 (3개 항목) - API URL 포트, Toast 무한 반복, 로그아웃 후 UI 업데이트
- 2026-01-16: 수동 테스트 버그 추가 수정 (1개 항목) - 로그아웃 후 불필요한 로그인 에러 메시지 제거

## 추가 노트

**보안 고려사항:**
- 첫 번째 사용자만 자동 admin
- 그 후는 명시적 역할 변경만 가능
- Admin Dashboard 접근 권한 있는 사용자만 역할 변경 가능

**테스트 시나리오:**
1. users 테이블 비어있음 → 첫 번째 사용자 admin으로 생성
2. 한 명 있음 → 두 번째 사용자 user로 생성
3. Admin이 일반 사용자를 admin으로 승격

---

_Story created: 2026-01-14_
